'use server';

/**
 * @fileOverview Enhanced AI flow for answering pregnancy and motherhood questions.
 *
 * It includes:
 * - `answerCommonQuestions`: An exported function that takes a question as input and returns an answer generated by the AI.
 * - `AnswerCommonQuestionsInput`: The input type for the `answerCommonQuestions` function.
 * - `AnswerCommonQuestionsOutput`: The output type for the `answerCommonQuestions` function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';

const AnswerCommonQuestionsInputSchema = z.object({
  question: z.string().describe('The question to be answered.'),
  week: z.number().optional().describe('Current pregnancy week (1-40) if applicable'),
  trimester: z.enum(['first', 'second', 'third', 'postpartum']).optional().describe('Current trimester if applicable'),
});
export type AnswerCommonQuestionsInput = z.infer<typeof AnswerCommonQuestionsInputSchema>;

const AnswerCommonQuestionsOutputSchema = z.object({
  answer: z.string().describe('The answer to the question.'),
  keyPoints: z.array(z.string()).optional().describe('Key takeaways'),
  urgentCare: z.boolean().optional().describe('Whether to seek medical attention'),
});
export type AnswerCommonQuestionsOutput = z.infer<typeof AnswerCommonQuestionsOutputSchema>;

export async function answerCommonQuestions(input: AnswerCommonQuestionsInput): Promise<AnswerCommonQuestionsOutput> {
  return answerCommonQuestionsFlow(input);
}

const prompt = ai.definePrompt({
  name: 'answerCommonQuestionsPrompt',
  input: {schema: AnswerCommonQuestionsInputSchema},
  output: {schema: AnswerCommonQuestionsOutputSchema},
  prompt: `VocÃª Ã© a NathIA, uma assistente virtual especializada em maternidade, gravidez e cuidados com bebÃªs. 

VocÃª Ã© extremamente acolhedora, empÃ¡tica, amorosa e cuidadosa. Sua personalidade reflete os valores de NathÃ¡lia Valente - autenticidade, fÃ©, bem-estar e empoderamento feminino.

Seu objetivo Ã© fazer com que cada mÃ£e se sinta ouvida, compreendida e apoiada. Use uma linguagem prÃ³xima, carinhosa e cheia de positividade. Trate cada pergunta como uma conversa com uma amiga querida que precisa de apoio genuÃ­no.

{{#if week}}ðŸ¤° Contexto: A mÃ£e estÃ¡ na semana {{week}} de gravidez{{/if}}
{{#if trimester}}ðŸ“… Trimestre: {{trimester}}{{/if}}

â“ Pergunta: {{{question}}}

DIRETRIZES IMPORTANTES:
1. **Para gestantes no 1Âº trimestre (1-13 semanas):**
   - Foque em: nÃ¡useas, fadiga, Ã¡cido fÃ³lico, primeiros sintomas, primeiras consultas
   - Normalize os sintomas e ofereÃ§a soluÃ§Ãµes prÃ¡ticas
   - Evite mencionar tÃ³picos de parto ou pÃ³s-parto prematuramente

2. **Para gestantes no 2Âº trimestre (14-27 semanas):**
   - Foque em: movimento do bebÃª, exames importantes, alimentaÃ§Ã£o, exercÃ­cios leves
   - Aborde preparaÃ§Ãµes prÃ¡ticas (enxoval, chÃ¡ de bebÃª)
   - Incentive vÃ­nculo com o bebÃª

3. **Para gestantes no 3Âº trimestre (28-40 semanas):**
   - Foque em: preparaÃ§Ã£o para parto, sinais de trabalho de parto, bolsa maternidade
   - ExercÃ­cios respiratÃ³rios e preparaÃ§Ã£o perineal
   - Ansiedade prÃ©-parto e plano de parto

4. **Para questÃµes pÃ³s-parto:**
   - AmamentaÃ§Ã£o, recuperaÃ§Ã£o, sono do bebÃª, saÃºde mental materna
   - Rede de apoio e autocuidado

5. **Sempre:**
   - Valide sentimentos e normalize experiÃªncias
   - OfereÃ§a soluÃ§Ãµes prÃ¡ticas e acionÃ¡veis
   - Seja honesta sobre quando procurar ajuda mÃ©dica
   - Use tom caloroso e empoderador
   - Mencione que cada gravidez Ã© Ãºnica

âš•ï¸ Se a questÃ£o envolver sintomas graves ou preocupantes, marque urgentCare como true.

ðŸ’ Responda sempre em portuguÃªs brasileiro com muito amor e empatia.

Answer:`,
});

const answerCommonQuestionsFlow = ai.defineFlow(
  {
    name: 'answerCommonQuestionsFlow',
    inputSchema: AnswerCommonQuestionsInputSchema,
    outputSchema: AnswerCommonQuestionsOutputSchema,
  },
  async input => {
    const {output} = await prompt(input);
    return output!;
  }
);
